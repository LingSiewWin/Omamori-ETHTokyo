<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMAMORI - Deposit</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="../zk-proofs/proof-generator.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 400px; margin: 0 auto; background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .step { background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; }
        .step.active { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .button { background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; width: 100%; margin: 8px 0; font-size: 16px; }
        .button:hover { background: #45a049; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .amount-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; text-align: center; }
        .zk-badge { background: #9c27b0; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; }
        .progress { text-align: center; margin: 16px 0; }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 16px;">
                <div style="background: linear-gradient(45deg, #ff6b35, #f7931e); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">JSC</div>
                <span style="font-size: 28px;">ğŸŒ¸</span>
            </div>
            <h1>ğŸŒ¸ Smart Deposit</h1>
            <p id="goal-info">Loading goal...</p>
            <div style="background: #fff3e0; padding: 6px 12px; border-radius: 12px; display: inline-block; font-size: 10px; color: #e65100; margin-top: 4px;">
                ğŸ” JSC Privacy Layer â€¢ ğŸ›ï¸ Chain ID 8888
            </div>
        </div>

        <!-- Amount Selection -->
        <div id="amount-section" class="step active">
            <h3>ğŸ’° Deposit Amount</h3>
            <input type="number" id="amount-input" class="amount-input" placeholder="Enter amount" />
            <div style="margin: 16px 0;">
                <button class="button" onclick="setQuickAmount('suggested')" id="suggested-btn">Suggested: Â¥1,000</button>
                <button class="button" onclick="setQuickAmount('daily')" style="background: #ff9800;">Daily Target: Â¥500</button>
                <button class="button" onclick="setQuickAmount('custom')" style="background: #9e9e9e;">Custom Amount</button>
            </div>
        </div>

        <!-- Privacy Selection -->
        <div id="privacy-section" class="step">
            <h3>ğŸ”’ Privacy Level</h3>
            <p>Choose verification method for your deposit</p>
            <button class="button" onclick="selectPrivacy('public')">
                ğŸ“Š Public (Standard)
            </button>
            <button class="button" onclick="selectPrivacy('zk')" style="background: #9c27b0;">
                ğŸ” Private <span class="zk-badge">JSC ZK-SNARK</span>
            </button>
            <button class="button" onclick="selectPrivacy('tee')" style="background: #ff5722;">
                ğŸ›¡ï¸ TEE Verified <span class="zk-badge">AIXSociety</span>
            </button>
        </div>

        <!-- Deposit Processing -->
        <div id="processing-section" class="step hidden">
            <h3>âš¡ Processing Deposit</h3>
            <div class="progress">
                <div id="step1">â³ 1. Generating proof...</div>
                <div id="step2">â³ 2. Signing transaction...</div>
                <div id="step3">â³ 3. Minting NFT...</div>
                <div id="step4">â³ 4. Notifying LINE...</div>
            </div>
        </div>

        <!-- Success -->
        <div id="success-section" class="step hidden">
            <h3>ğŸ‰ Deposit Complete!</h3>
            <div style="text-align: center; margin: 20px 0;">
                <div style="font-size: 48px;">ğŸŒ¸</div>
                <div id="nft-info" class="success">NFT #12345 minted</div>
                <div id="deposit-summary"></div>
            </div>
            <button class="button" onclick="returnToLine()">ğŸ“± Return to LINE</button>
            <button class="button" onclick="shareProgress()" style="background: #1976d2;">ğŸ”— Share Progress</button>
        </div>

        <!-- JPY Guide -->
        <div id="jpy-guide" class="step" style="background: #fff8e1; border-left: 4px solid #ff9800;">
            <h3>ğŸ’± Need JPY â†’ USDC?</h3>
            <p style="font-size: 14px;">Manual swap recommended:</p>
            <button class="button" onclick="openSBILink()" style="background: #ff9800;">
                ğŸ¦ SBI VC Trade
            </button>
        </div>
    </div>

    <script>
        let currentAmount = 0;
        let privacyMode = 'public';
        let provider = null;
        let signer = null;

        // Contract addresses
        const VAULT_ADDRESS = "0x4c7271d91121f5ee40a5a303930db3140df68bbf";
        const NFT_ADDRESS = "0xcdd7965f19103d34f4e70f540f5f6f6fa426ede1";

        const NETWORK_CONFIG = {
            chainId: "0x22b8", // 8888 in hex (JSC Kaigan)
            chainName: "Japan Smart Chain Kaigan",
            nativeCurrency: { name: "JSC", symbol: "JSC", decimals: 18 },
            rpcUrls: ["https://rpc.kaigan.jsc.dev/rpc"],
            blockExplorerUrls: ["https://scan.kaigan.jsc.dev/"]
        };

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const goal = urlParams.get('goal') || 'Savings Goal';
        const suggestedAmount = parseInt(urlParams.get('amount')) || 1000;
        const dailyAmount = Math.floor(suggestedAmount * 0.5);

        // Initialize
        document.getElementById('goal-info').textContent = `Goal: ${goal}`;
        document.getElementById('suggested-btn').textContent = `Suggested: Â¥${suggestedAmount.toLocaleString()}`;
        document.getElementById('suggested-btn').onclick = () => setQuickAmount(suggestedAmount);

        function setQuickAmount(type) {
            if (type === 'daily') {
                currentAmount = dailyAmount;
            } else if (typeof type === 'number') {
                currentAmount = type;
            } else {
                return; // Custom input mode
            }

            document.getElementById('amount-input').value = currentAmount;
            showSection('privacy-section');
        }

        function selectPrivacy(mode) {
            privacyMode = mode;
            processDeposit();
        }

        async function processDeposit() {
            currentAmount = parseInt(document.getElementById('amount-input').value);

            if (!currentAmount || currentAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            showSection('processing-section');

            try {
                // Step 1: Generate ZK/TEE proof (mock)
                document.getElementById('step1').innerHTML = 'ğŸ”„ 1. Generating proof...';
                await generateProof(privacyMode);
                document.getElementById('step1').innerHTML = 'âœ… 1. Proof generated';

                // Step 2: Connect wallet and sign
                document.getElementById('step2').innerHTML = 'ğŸ”„ 2. Signing transaction...';
                await connectAndSign();
                document.getElementById('step2').innerHTML = 'âœ… 2. Transaction signed';

                // Step 3: Mock NFT minting
                document.getElementById('step3').innerHTML = 'ğŸ”„ 3. Minting NFT...';
                await mockNFTMint();
                document.getElementById('step3').innerHTML = 'âœ… 3. NFT minted';

                // Step 4: LINE callback
                document.getElementById('step4').innerHTML = 'ğŸ”„ 4. Notifying LINE...';
                await notifyLine();
                document.getElementById('step4').innerHTML = 'âœ… 4. LINE updated';

                showSuccess();

            } catch (error) {
                console.error('Deposit failed:', error);
                alert('Deposit failed: ' + error.message);
                showSection('amount-section');
            }
        }

        async function generateProof(mode) {
            if (mode === 'zk') {
                console.log('ğŸ” Generating real ZK-SNARK proof for JSC privacy layer...');

                // Initialize ZK proof generator
                const zkGen = new OmamoriProofGenerator();

                // Generate random salt for commitment
                const salt = Math.floor(Math.random() * 1000000);

                const privateInputs = {
                    amount: currentAmount,
                    salt: salt
                };

                const publicInputs = {
                    minThreshold: 100,    // Min 100 JPY
                    maxThreshold: 1000000 // Max 1M JPY
                };

                try {
                    const zkProofResult = await zkGen.generateProof(privateInputs, publicInputs);

                    return {
                        proof: zkProofResult.proof,
                        publicSignals: zkProofResult.publicSignals,
                        metadata: zkProofResult.metadata,
                        type: 'zk-snark',
                        circuit: 'omamori-privacy-proof',
                        commitment: zkProofResult.metadata.commitmentHash
                    };
                } catch (error) {
                    console.error('ZK proof generation failed:', error);
                    throw new Error('ZK proof generation failed: ' + error.message);
                }

            } else if (mode === 'tee') {
                console.log('ğŸ›¡ï¸ TEE verification for AIXSociety compatibility');
                await new Promise(resolve => setTimeout(resolve, 2000));

                return {
                    attestation: '0x' + Array(32).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join(''),
                    enclave: 'omamori-tee-v1',
                    sgxQuote: '0x' + Array(96).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join(''),
                    type: 'tee-attestation'
                };
            }

            // Public mode - no proof needed
            await new Promise(resolve => setTimeout(resolve, 500));
            return { type: 'public' };
        }

        async function connectAndSign() {
            if (typeof window.ethereum === 'undefined') {
                throw new Error('Please install MetaMask!');
            }

            provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send("eth_requestAccounts", []);

            // Switch network
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: NETWORK_CONFIG.chainId }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [NETWORK_CONFIG]
                    });
                }
            }

            signer = await provider.getSigner();
            const account = await signer.getAddress();

            // EIP-712 signature
            const domain = {
                name: 'OmamoriVault',
                version: '1',
                chainId: 8888, // JSC Kaigan
                verifyingContract: VAULT_ADDRESS
            };

            const types = {
                Deposit: [
                    { name: 'user', type: 'address' },
                    { name: 'amount', type: 'uint256' },
                    { name: 'asset', type: 'string' },
                    { name: 'goal', type: 'string' },
                    { name: 'privacy', type: 'string' }
                ]
            };

            const value = {
                user: account,
                amount: ethers.parseUnits(currentAmount.toString(), 0),
                asset: 'USDC',
                goal: goal,
                privacy: privacyMode
            };

            const signature = await signer.signTypedData(domain, types, value);
            console.log('ğŸ“ EIP-712 Signature:', signature);
            return signature;
        }

        async function mockNFTMint() {
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Mock NFT minting on OmamoriNFT contract
            const mockNFTId = Math.floor(Math.random() * 10000) + 1000;

            return {
                nftId: mockNFTId,
                contract: NFT_ADDRESS,
                level: 'seed',
                evolution: determineMilestone(currentAmount)
            };
        }

        function determineMilestone(amount) {
            if (amount >= 10000) return 'bloom';
            if (amount >= 5000) return 'flower';
            if (amount >= 1000) return 'sprout';
            return 'seed';
        }

        async function notifyLine() {
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Send success back to LINE bot
            const successData = {
                userId: 'mock_user_id',
                amount: currentAmount,
                goal: goal,
                privacy: privacyMode,
                timestamp: new Date().toISOString()
            };

            // Mock LINE LIFF postMessage
            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.sendMessages([{
                    type: 'text',
                    text: `âœ… Â¥${currentAmount.toLocaleString()}ã®å…¥é‡‘ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nç›®æ¨™: ${goal}\nãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼: ${privacyMode.toUpperCase()}`
                }]);
            }

            console.log('ğŸ“± LINE notification sent:', successData);
        }

        function showSuccess() {
            const mockNFTId = Math.floor(Math.random() * 10000) + 1000;
            document.getElementById('nft-info').textContent = `NFT #${mockNFTId} minted`;
            document.getElementById('deposit-summary').innerHTML = `
                <div style="margin: 16px 0; padding: 16px; background: #e8f5e8; border-radius: 8px;">
                    <div><strong>Amount:</strong> Â¥${currentAmount.toLocaleString()}</div>
                    <div><strong>Goal:</strong> ${goal}</div>
                    <div><strong>Privacy:</strong> ${privacyMode.toUpperCase()}</div>
                    <div><strong>Level:</strong> ${determineMilestone(currentAmount)} ğŸŒ±</div>
                </div>
            `;
            showSection('success-section');
        }

        function showSection(sectionId) {
            // Hide all sections
            const sections = ['amount-section', 'privacy-section', 'processing-section', 'success-section'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('active');
            });

            // Show target section
            const target = document.getElementById(sectionId);
            target.classList.remove('hidden');
            target.classList.add('active');
        }

        function returnToLine() {
            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.history.back();
            }
        }

        function shareProgress() {
            const shareText = `ğŸŒ¸ OMAMORI savings update!\nÂ¥${currentAmount.toLocaleString()} deposited for ${goal}\nJoin me: https://omamori-bot-demo.loca.lt`;

            if (navigator.share) {
                navigator.share({
                    title: 'OMAMORI Progress',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText);
                alert('Progress copied to clipboard!');
            }
        }

        function openSBILink() {
            window.open('https://www.sbivc.co.jp/', '_blank');
        }

        // Initialize LIFF
        if (typeof liff !== 'undefined') {
            liff.init({ liffId: '2008105247' }).catch(console.error);
        }
    </script>
</body>
</html>